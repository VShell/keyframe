From 0eff369b2e08e59656d650f5dbafa58396d3833e Mon Sep 17 00:00:00 2001
From: Shell Turner <shell@alterednarrative.net>
Date: Sun, 10 May 2020 14:04:34 +0100
Subject: [PATCH 1/2] Check the prefix for share and module directories

---
 configure                  | 1 +
 src/utils/os_config_init.c | 4 +++-
 2 files changed, 4 insertions(+), 1 deletion(-)

diff --git a/configure b/configure
index 7bc33e026..d84353ab8 100755
--- a/configure
+++ b/configure
@@ -2298,6 +2298,7 @@ TMPH="${TMPDIR1}/gpac-conf-${RANDOM}-$$-${RANDOM}.h"
 echo "/* Automatically generated by configure */" > $TMPH
 echo "#ifndef GF_CONFIG_H" >> $TMPH
 echo "#define GF_CONFIG_H" >> $TMPH
+echo "#define GPAC_PREFIX \"$prefix\"" >> $TMPH
 echo "#define GPAC_CONFIGURATION \"$GPAC_CONFIGURATION\"" >> $TMPH
 
 version="`grep '#define GPAC_VERSION ' \"$source_path/include/gpac/version.h\" | cut -d '"' -f 2`"
diff --git a/src/utils/os_config_init.c b/src/utils/os_config_init.c
index 30eb84074..781e7fb0f 100644
--- a/src/utils/os_config_init.c
+++ b/src/utils/os_config_init.c
@@ -384,15 +384,17 @@ static Bool get_default_install_path(char *file_path, u32 path_type)
 	}
 
 	/*installed or symlink on system, user user home directory*/
-	if (!strnicmp(app_path, "/usr/", 5) || !strnicmp(app_path, "/opt/", 5)) {
+	if (!strnicmp(app_path, "/usr/", 5) || !strnicmp(app_path, "/opt/", 5) || !strnicmp(app_path, "/nix/", 5)) {
 		if (path_type==GF_PATH_SHARE) {
 			/*look in possible install dirs ...*/
+			if (check_file_exists("gui/gui.bt", GPAC_PREFIX "/share/gpac", file_path)) return 1;
 			if (check_file_exists("gui/gui.bt", "/usr/share/gpac", file_path)) return 1;
 			if (check_file_exists("gui/gui.bt", "/usr/local/share/gpac", file_path)) return 1;
 			if (check_file_exists("gui/gui.bt", "/opt/share/gpac", file_path)) return 1;
 			if (check_file_exists("gui/gui.bt", "/opt/local/share/gpac", file_path)) return 1;
 		} else if (path_type==GF_PATH_MODULES) {
 			/*look in possible install dirs ...*/
+			if (check_file_exists(TEST_MODULE, GPAC_PREFIX "/lib/gpac", file_path)) return 1;
 			if (check_file_exists(TEST_MODULE, "/usr/lib64/gpac", file_path)) return 1;
 			if (check_file_exists(TEST_MODULE, "/usr/lib/gpac", file_path)) return 1;
 			if (check_file_exists(TEST_MODULE, "/usr/local/lib/gpac", file_path)) return 1;
-- 
2.27.0

