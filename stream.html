<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<link rel="stylesheet" type="text/css" media="screen" href="https://cdn.conversejs.org/5.0.1/dist/converse.min.css">
<script src="https://cdn.conversejs.org/5.0.1/dist/converse.js" charset="utf-8"></script>
<style>
#conversejs {
  --occupants-features-display: none;
  --occupants-border-bottom: none;
}

#conversejs .chat-head {
  display: none;
}

#video {
  max-width: 100%;
}

@media (max-width:767.98px) {
  #conversejs {
    display: none;
  }
}
</style>
<script>
converse.plugins.add('hide-chatroom-participants', {
  dependencies: ['converse-muc-views'],
  overrides: {
    ChatRoomView: {
      initialize: function() {
        if(!this.model.has('hidden_occupants')) {
          this.model.save({'hidden_occupants': true});
        }
        this.__super__.initialize.apply(this, arguments);
      },
      renderAfterTransition: function() {
        this.__super__.renderAfterTransition.apply(this, arguments);
        if(this.model.get('hidden_occupants')) {
          converse.env.utils.hideElement(this.el.querySelector('.occupants'));
          this.scrollDown();
        }
      },
    },
  },
});
</script>

<body style="height:100%;padding:0;margin:0;">
<div style="height:100%; display:grid; grid-template-columns:2fr 1fr; grid-auto-rows:100%;">
<div id="videocontainer">
<video id="video"></video>
<h1 id="streamsubject"></h1>
</div>
<div id="conversejs"></div>
</div>

<script>
var domain = location.host;
var stream = location.pathname.match(/[^/]+$/)[0];
var room_jid = stream+'@streamchat.'+domain;

var url = '/stream/'+stream+'.m3u8';
var video = document.getElementById('video');
if(Hls.isSupported()) {
  var hls = new Hls();
  hls.loadSource(url);
  hls.attachMedia(video);
  hls.on(Hls.Events.MANIFEST_PARSED,function() {
    video.play();
  });
}
else if (video.canPlayType('application/vnd.apple.mpegurl')) {
  video.src = url;
  video.addEventListener('loadedmetadata',function() {
    video.play();
  });
}

converse.initialize({
  bosh_service_url: '/stream-meta/bosh',
  view_mode: 'embedded',
  singleton: true,
  whitelisted_plugins: [
    'hide-chatroom-participants',
  ],
  authentication: 'anonymous',
  auto_login: true,
  allow_logout: false,
  jid: 'streamguest.'+domain,
  auto_join_rooms: [
    room_jid,
  ],
  notify_all_room_messages: [
    room_jid,
  ],
  hide_muc_server: true,
  allow_muc_invitations: false,
});
</script>
</body>
